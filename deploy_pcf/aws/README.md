# deploy-pcf-aws
===

## Overview

This Concourse pipeline is used to quickly spin up a PCF environment using the [p-runtime gem](https://github.com/pivotal-cf/p-runtime). The purpose of this pipeline is to quickly provider test/development PCF environments on AWS.

**Note: This pipeline does not work with ERT 1.6.**

* The pipeline will deploy a single-az PCF environment on AWS with a self-signed cert.

* The pipeline of interest is named: **deploy-pcf-aws.yml**

* This pipeline is separated into 3 pipeline groups:

  * bootstrap-aws
  * deploy-pcf
  * destroy-pcf-aws

  
## deploy-pcf-aws.yml

#### Prerequisites:

* Github key that has access to pivotal-cf/p-runtime
* Pivnet API token
* Github repo for storing credentials and deployment manifest
* an ssh keypair for AWS to use when deploying instances must be added to this repo.
 **NOTE**: make sure your key-pair name (format: id_rsa_\<ENV_NAME\>)

You can create a new keypair with the command:
```
$ ssh-keygen -t rsa -f $environment_yml_git_repo/$environment_yml_folder/$aws_private_key_file_name

#Example:
$ ssh-keygen -t rsa -f /Users/pivotal/workspace/deployments-toolsmiths/aws/environments/<ENV_NAME>/id_rsa_<ENV_NAME>

```

#### Caveats:

You will need to ensure the wildcard cname and A record for the Ops Manager and PCF ELB does not exist before running the script.

#### Usage:

Edit deploy-pcf-aws.yml and configure the following values at the top of the file:

```
# === concourse ===
worker_tag: &worker_tag
github_user: &github_user cf-toolsmiths
github_email: &github_email cf-toolsmiths@pivotal.io
github_key: &github_key {{github-key}}
download_retry_attempts: &retry 3


# === pivnet ===
pivnet_token: &pivnet_token {{pivnet-token}}
opsmgr_version: &opsmgr_version 1.7.9
ert_version: &ert_version 1.7.9

# ===environment config ===
iaas: &iaas aws

environment_yml_git_repo: &environment_yml_git_repo git@github.com:<YOUR-ORG>/<YOUR-REPO>
environment_yml_folder: &environment_yml_folder aws/environments/<ENVIRONMENT-NAME> # this is the path within your git repo

aws_access_key_id: &aws_access_key_id {{aws-access-key-id}}
aws_secret_access_key: &aws_secret_access_key {{aws-secret-access-key}}
aws_environment_name: &aws_environment_name <ENVIRONMENT-NAME>
aws_system_domain: &aws_system_domain <ENVIRONMENT-NAME>.example.com
aws_key_pair_name: &aws_key_pair_name <ENVIRONMENT-KEY-PAIR-NAME>
aws_rds_username: &aws_rds_username <RDS-USERNAME>
aws_rds_password: &aws_rds_password <RDS-PASSWORD>
aws_public_key: &aws_public_key <PUBLIC-KEY-STRING>
aws_private_key_file_name: &aws_private_key_file_name <PRIVATE-KEY-FILENAME> # this key is expected to be inside your environment folder inside the git repo
aws_region: &aws_region <AWS-REGION>
aws_s3_endpoint: &aws_s3_endpoint 'https://s3.amazonaws.com' # This varies per region: http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region

ops_manager_password: &ops_manager_password <YOUR-OPSMANAGER-PASSWORD>

aws_route_53_access_key_id: &aws_route53_access_key_id {{aws-route53-access-key-id}}
aws_route_53_secret_access_key: &aws_route53_secret_access_key {{aws-route53-secret-access-key}}
aws_route_53_hosted_zone_id: &aws_route53_hosted_zone_id {{aws-route53-hosted-zone-id}}
ops_manager_fqdn: &ops_manager_fqdn <YOUR-OPSMANAGER-FQDN>

# OPTIONAL: This is for setting up E-mail notifications. If you do not want to set this up, delete the values "<...>"
smtp_from: &smtp_from <SMTP-FROM-ADDRESS>
smtp_address: &smtp_address <SMTP-ADDRESS>
smtp_port: &smtp_port <SMTP-PORT>
smtp_user: &smtp_user <SMTP-USER>
smtp_password: &smtp_password <SMTP-PASSWORD>
```

### bootstrap-aws

The pipeline group will do the following:

* Generate a self-signed certificate and upload to AWS IAM using the awscli
* Upload your private key to your AWS account
* Download the corresponding cloudformation.json from Pivotal Network
* Run the cloudformation template using your defined aws credentials, regions, azs

### deploy-pcf

This pipeline group will do the following:

* Verify or generate your <ENVIRONMENT>.yml inside your environment repo
* Create your ops manager vm inside the region you specified
* Configure your Ops Manager director
* Download and upload the specified ERT tile from Pivotal Network and upload it to Ops Manager
* Configure the Elastic Runtime tile to use the self-signed cert, s3 buckets, rds instance and etc. all generated from the first bootstrap-aws pipeline group
* The pipeline will then trigger your install and you will have a working PCF deployment!

### destroy-pcf-aws

This pipeline group has two manual triggers:

* **destroy-pcf-aws:** This step will purge your AWS account of everything in your environment. It will delete your PCF deployment as well as tear down all the subnets, RDS instances, VPCs and etc generated by your cloudformation script

* **delete-all-bootstrap-resources:** This step is used if you made a mistake in your bootstrapping process. This step will delete the key uploaded to your AWS account as well as delete the cloudformation stack.
